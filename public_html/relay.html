<!DOCTYPE html>
<html>
    <head>
        <title>Relay</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <script type="text/javascript" src="libs/jq.js"></script>
        <script type="text/javascript" src="libs/localForage.js"></script>
        <script type="text/javascript" src="config.js"></script>
        <script type="text/javascript">
            var handler = {"hasListeners": false, "type": "relay"};
            localforage.config(lfConfig);
        </script>
        <script type="text/javascript" src="scripts/websocket.js"></script>
        <script type="text/javascript" src="scripts/rtcConns.js"></script>
        <script type="text/javascript">
            initWS();
            function pcMessage(peerconn, dc, data)
            {
                if (data.action === "userLoc")
                {
                    var user = data.username;
                    localforage.getItem("user_" + user + "_stores").then(function (stores) {
                        if (!stores)
                        {
                            var answer = new Object();
                            answer.action = "getUserInfo";
                            answer.status = "notKnown";
                            dc.send(JSON.stringify(answer));
                        }
                        else
                        {
                            localforage.getItem("user_" + user + "_hash").then(function (hash) {
                                if (!hash)
                                {
                                    var answer = new Object();
                                    answer.action = "getUserInfo";
                                    answer.status = "requestOther";
                                    dc.send(JSON.stringify(answer));
                                }
                                else
                                {
                                    var answer = new Object();
                                    answer.action = "getUserInfo";
                                    answer.status = "ok";
                                    answer.stores = stores;
                                    answer.hash = hash;
                                    dc.send(JSON.stringify(answer));
                                }
                            });
                        }
                    });
                }
                else if (data.action === "register")
                {
                    var userHash = data.user;
                    var storagers = data.storagers;
                    var dataHash = data.hash;
                    localforage.setItem("user_" + userHash + "_stores", storagers);
                    localforage.setItem("user_" + userHash + "_hash", dataHash);
                    //TODO: Distribute the data over the network
                }
                else if (data.action === "addStore")
                {
                    var userHash = data.user;
                    var storager = data.storager;
                    localforage.getItem("user_" + userHash + "_stores").then(function (data) {
                        var stores = new Array();
                        if (data)
                        {
                            stores = JSON.parse(data);
                        }
                        stores.push(storager);
                        localforage.setItem("user_" + userHash + "_stores", JSON.stringify(stores));
                    });
                }
            }
        </script>
    </head>
    <body>
        <h1>Keep this site open</h1>
    </body>
</html>
