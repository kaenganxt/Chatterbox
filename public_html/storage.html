<!DOCTYPE html>

<html>
    <head>
        <title>Storage</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <script type="text/javascript" src="libs/jq.js"></script>
        <script type="text/javascript" src="libs/localForage.js"></script>
        <script type="text/javascript" src="config.js"></script>
        <script type="text/javascript">
            var handlerType = "storage";
        </script>
        <script type="text/javascript" src="scripts/handler.js"></script>
        <script type="text/javascript">
            
            function generateStr() {
                var chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!?#+*/-+|%&ยง";
                var string = "";
                for (var i = 0; i < 20; i++) {
                    string += chars[Math.floor(Math.random()*chars.length)];
                }
                return string;
            }
            function wsMessage(data)
            {
                if (data.action === "noRelays")
                {
                    $("body").append("No services available for network-integration...");
                    setTimeout(function () {
                        window.location.reload();
                    }, 1000);
                }
            }
            function pcMessage(data, datachannel)
            {
                if (data.action === "login")
                {
                    var usr = data.username;
                    var pw = data.pwHash;
                    localforage.getItem("user_" + usr + "_data").then(function (userdata) {
                        var obj = new Object();
                        obj.action = "login";
                        if (!userdata)
                        {
                            obj.status = "notKnown";
                        }
                        else
                        {
                            if (userdata.pwHash !== pw)
                            {
                                obj.status = "pwWrong";
                            }
                            else
                            {
                                obj.status = "ok";
                                obj.data = userdata.enc;
                            }
                        }
                        datachannel.send(JSON.stringify(obj));
                    });
                }
                else if (data.action === "register")
                {
                    var user = data.usrName;
                    var pw = data.pw;
                    var enc = data.encoded;
                    var obj = new Object();
                    obj.pwHash = pw;
                    obj.enc = enc;
                    localforage.setItem("user_" + user + "_data", obj);
                }
            }
        </script>
    </head>
    <body>
        <h1>Keep this site open</h1>
    </body>
</html>